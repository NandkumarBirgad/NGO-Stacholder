{% extends "base.html" %}
{% block content %}
<div class="page-title" style="display: flex !important; align-items: flex-start !important; justify-content: space-between !important; gap: 24px !important; margin-bottom: 32px !important;">
  <div style="flex: 1;">
    <h1>Stakeholders</h1>
    <div class="subtitle">Manage volunteers, donors, beneficiaries, and partners</div>
  </div>
  <div style="flex-shrink: 0 !important; display: block !important; visibility: visible !important; opacity: 1 !important;">
    <button class="add-btn" onclick="showAddStakeholderForm(); return false;">
      <i class="fas fa-plus"></i> Add Stakeholder
    </button>
  </div>
</div>

<div class="search-row">
  <input type="search" id="stakeSearch" placeholder="ðŸ” Search stakeholders by name or email..." />
  <select id="typeFilter">
    <option value="">All Types</option>
    <option value="volunteer">Volunteer</option>
    <option value="donor">Donor</option>
    <option value="beneficiary">Beneficiary</option>
  </select>
  <select id="statusFilter">
    <option value="">All Status</option>
    <option value="Active">Active</option>
    <option value="Inactive">Inactive</option>
  </select>
</div>

<div class="table">
  <table id="stakeholdersTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Contact</th>
        <th>Location</th>
        <th>Status</th>
        <th>Joined</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="6" style="text-align:center; color:var(--muted); padding:40px;">
          <i class="fas fa-spinner fa-spin" style="font-size:24px; margin-bottom:12px;"></i>
          <div>Loading stakeholders...</div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Modal for Add Stakeholder Form -->
<div id="addStakeholderModal" class="modal" style="display:none;">
  <div class="form-container" style="max-width: 650px; margin: 40px auto;">
    <header class="form-header">
      <h2><i class="fas fa-user-plus" style="margin-right:10px;"></i>Add New Stakeholder</h2>
      <button class="close-btn" onclick="closeForm()" type="button">Ã—</button>
    </header>

    <form id="stakeholderForm" style="padding: 32px;">
      <div class="form-row full-width">
        <div class="form-group">
          <label for="fullName">Full Name *</label>
          <input type="text" id="fullName" name="fullName" required placeholder="Enter full name">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="type">Type *</label>
          <select id="type" name="type" required>
            <option value="volunteer">Volunteer</option>
            <option value="donor">Donor</option>
            <option value="beneficiary">Beneficiary</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label for="phone">Phone</label>
          <input type="tel" id="phone" name="phone" placeholder="+1 234 567 8900">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" name="city" placeholder="City name">
        </div>
        <div class="form-group">
          <label for="joinedDate">Joined Date</label>
          <input type="date" id="joinedDate" name="joinedDate" value="">
        </div>
      </div>

      <div class="form-row full-width">
        <div class="form-group">
          <label for="address">Address</label>
          <textarea id="address" name="address" placeholder="Full address" rows="3"></textarea>
        </div>
      </div>

      <div class="form-row full-width">
        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" rows="4" placeholder="Additional notes or comments"></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn cancel-btn" onclick="closeForm()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn create-btn">
          <i class="fas fa-check"></i> Create
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let allStakeholders = [];
  
  // Make function globally accessible - define it immediately (before DOM ready)
  window.showAddStakeholderForm = function() {
    console.log('showAddStakeholderForm called');
    const modal = document.getElementById('addStakeholderModal');
    if (modal) {
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.getElementById('joinedDate');
      if (dateInput) {
        dateInput.value = today;
      }
      console.log('Modal opened');
    } else {
      console.error('Modal not found!');
      alert('Form modal not found. Please refresh the page.');
    }
  };
  
  // Verify button exists on page load
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.querySelector('.page-title .add-btn');
    console.log('Button found:', btn);
    if (btn) {
      console.log('Button styles:', window.getComputedStyle(btn));
      // Force button to be visible
      btn.style.display = 'inline-flex';
      btn.style.visibility = 'visible';
      btn.style.opacity = '1';
    } else {
      console.error('Add button not found in DOM!');
    }
  });

  // Handle form submission
  document.getElementById('stakeholderForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="loading"></span> Creating...';
    submitBtn.disabled = true;

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/api/add_stakeholder', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      
      if (result.success) {
        if (typeof showNotification === 'function') {
          showNotification('Stakeholder added successfully!', 'success');
        } else {
          alert('Stakeholder added successfully!');
        }
        closeForm();
        loadStakeholders();
        // Trigger dashboard refresh
        if (typeof triggerDashboardRefresh === 'function') {
          triggerDashboardRefresh();
        } else {
          localStorage.setItem('dashboardRefresh', Date.now().toString());
        }
      } else {
        if (typeof showNotification === 'function') {
          showNotification('Error: ' + result.message, 'error');
        } else {
          alert('Error adding stakeholder: ' + result.message);
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      if (typeof showNotification === 'function') {
        showNotification('Error adding stakeholder', 'error');
      } else {
        alert('Error adding stakeholder');
      }
    });
  });

  // Load and filter stakeholders
  function loadStakeholders() {
    const tbody = document.querySelector('#stakeholdersTable tbody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--muted); padding:40px;"><i class="fas fa-spinner fa-spin" style="font-size:24px; margin-bottom:12px;"></i><div>Loading stakeholders...</div></td></tr>';
    
    fetch('/api/stakeholders')
      .then(r => r.json())
      .then(data => {
        allStakeholders = data;
        filterAndRenderStakeholders();
      })
      .catch(err => {
        console.error('Error loading stakeholders:', err);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger); padding:40px;">Error loading stakeholders</td></tr>';
      });
  }

  function filterAndRenderStakeholders() {
    const searchQuery = document.getElementById('stakeSearch').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filtered = allStakeholders.filter(item => {
      const matchesSearch = !searchQuery || 
        item.full_name?.toLowerCase().includes(searchQuery) ||
        item.email?.toLowerCase().includes(searchQuery) ||
        item.phone?.includes(searchQuery);
      const matchesType = !typeFilter || item.type === typeFilter;
      const matchesStatus = !statusFilter || item.status === statusFilter;
      
      return matchesSearch && matchesType && matchesStatus;
    });

    const tbody = document.querySelector('#stakeholdersTable tbody');
    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--muted); padding:40px;"><i class="fas fa-user-slash" style="font-size:32px; margin-bottom:12px; opacity:0.3;"></i><div>No stakeholders found</div></td></tr>';
      return;
    }

    const typeColors = {
      'volunteer': '#3b82f6',
      'donor': '#10b981',
      'beneficiary': '#f59e0b'
    };

    tbody.innerHTML = filtered.map(item => {
      const typeColor = typeColors[item.type] || '#64748b';
      const statusClass = item.status === 'Active' ? 'active' : 'inactive';
      const joinDate = item.join_date ? new Date(item.join_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
      
      return `
        <tr>
          <td style="font-weight:600; color:#0f172a;">${item.full_name || 'N/A'}</td>
          <td>
            <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:12px; background:${typeColor}15; color:${typeColor}; font-weight:600; font-size:12px; text-transform:capitalize;">
              <i class="fas fa-${item.type === 'volunteer' ? 'user' : item.type === 'donor' ? 'hand-holding-usd' : 'heart'}"></i>
              ${item.type || 'N/A'}
            </span>
          </td>
          <td>
            <div style="font-size:13px; color:#374151;">
              ${item.email ? `<div><i class="fas fa-envelope" style="margin-right:6px; color:var(--muted);"></i>${item.email}</div>` : ''}
              ${item.phone ? `<div style="margin-top:4px;"><i class="fas fa-phone" style="margin-right:6px; color:var(--muted);"></i>${item.phone}</div>` : ''}
            </div>
          </td>
          <td style="color:var(--muted); font-size:13px;">${item.address || 'N/A'}</td>
          <td><span class="status-badge ${statusClass}">${item.status || 'Active'}</span></td>
          <td style="color:var(--muted); font-size:13px;">${joinDate}</td>
        </tr>
      `;
    }).join('');
  }

  // Event listeners for filtering
  document.getElementById('stakeSearch').addEventListener('input', filterAndRenderStakeholders);
  document.getElementById('typeFilter').addEventListener('change', filterAndRenderStakeholders);
  document.getElementById('statusFilter').addEventListener('change', filterAndRenderStakeholders);

  // Load stakeholders when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadStakeholders();
    
    // Set default date
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('joinedDate');
    if (dateInput) {
      dateInput.value = today;
    }
  });
</script>
{% endblock %}

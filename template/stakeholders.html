{% extends "base.html" %}
{% block content %}
<div class="page-title">
  <div>
    <h1>Stakeholders</h1>
    <div class="subtitle">Manage volunteers, donors, beneficiaries, and partners</div>
  </div>
  <div>
    <button class="add-btn" onclick="showAddStakeholderForm()">+ Add Stakeholder</button>
  </div>
</div>

<div class="search-row">
  <input type="search" id="stakeSearch" placeholder="Search stakeholders..." />
  <select>
    <option>All Types</option>
    <option>Volunteer</option>
    <option>Donor</option>
    <option>Beneficiary</option>
  </select>
  <select>
    <option>All Status</option>
    <option>Active</option>
    <option>Inactive</option>
  </select>
</div>

<div class="table">
  <table id="stakeholdersTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Contact</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filled by client if we build list -->
      <tr><td colspan="4" style="text-align:center; color:var(--muted);">No stakeholders found</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal for Add Stakeholder Form -->
<div id="addStakeholderModal" class="modal" style="display:none;">
  <div class="form-container">
    <header class="form-header">
      <h2>Add New Stakeholder</h2>
      <button class="close-btn" onclick="closeForm()">Ã—</button>
    </header>

    <form id="stakeholderForm">
      <div class="form-row full-width">
        <label for="fullName">Full Name *</label>
        <input type="text" id="fullName" name="fullName" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="type">Type *</label>
          <select id="type" name="type" required>
            <option value="volunteer">Volunteer</option>
            <option value="donor">Donor</option>
            <option value="Beneficiary">Beneficiary</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email">
        </div>
        <div class="form-group">
          <label for="phone">Phone</label>
          <input type="tel" id="phone" name="phone">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" name="city">
        </div>
        <div class="form-group">
          <label for="joinedDate">Joined Date</label>
          <input type="date" id="joinedDate" name="joinedDate" value="2025-11-07">
        </div>
      </div>

      <div class="form-row full-width">
        <label for="address">Address</label>
        <textarea id="address" name="address"></textarea>
      </div>

      <div class="form-row full-width">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="4"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn cancel-btn" onclick="closeForm()">Cancel</button>
        <button type="submit" class="btn create-btn">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
  function showAddStakeholderForm() {
    document.getElementById('addStakeholderModal').style.display = 'block';
  }

  function closeAddStakeholderForm() {
    document.getElementById('addStakeholderModal').style.display = 'none';
    document.getElementById('stakeholderForm').reset();
  }

  // Show/hide fields based on stakeholder type
  document.getElementById('type').addEventListener('change', function(e) {
    const type = e.target.value;
    const statusGroup = document.getElementById('statusGroup');
    const joinDateGroup = document.getElementById('joinDateGroup');

    if (type === 'volunteer') {
      statusGroup.style.display = 'block';
      joinDateGroup.style.display = 'block';
    } else {
      statusGroup.style.display = 'none';
      joinDateGroup.style.display = 'none';
    }
  });

  // Handle form submission
  document.getElementById('stakeholderForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/api/add_stakeholder', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        alert('Stakeholder added successfully!');
        closeForm();
        // Refresh the stakeholders list
        loadStakeholders();
      } else {
        alert('Error adding stakeholder: ' + result.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error adding stakeholder');
    });
  });

  // Basic search hook (optional): call /api/search/stakeholders?q=...
  document.getElementById('stakeSearch').addEventListener('input', function(e){
    const q = e.target.value.trim();
    if (!q) return;
    fetch('/api/search/stakeholders?q=' + encodeURIComponent(q))
      .then(r => r.json())
      .then(data => {
        const tbody = document.querySelector('#stakeholdersTable tbody');
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--muted);">No stakeholders found</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(item =>
          `<tr>
            <td>${item.name}</td>
            <td>${item.type}</td>
            <td>${item.email || item.phone || ''}</td>
            <td>--</td>
          </tr>`).join('');
      });
  });

  // Load stakeholders on page load
  function loadStakeholders() {
    fetch('/api/stakeholders')
      .then(r => r.json())
      .then(data => {
        const tbody = document.querySelector('#stakeholdersTable tbody');
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--muted);">No stakeholders found</td></tr>';
          return;
        }
        tbody.innerHTML = data.map(item =>
          `<tr>
            <td>${item.full_name}</td>
            <td>${item.type}</td>
            <td>${item.email || item.phone || ''}</td>
            <td>${item.status || 'Active'}</td>
          </tr>`).join('');
      });
  }

  // Load stakeholders when page loads
  document.addEventListener('DOMContentLoaded', loadStakeholders);
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="page-title">
  <div>
    <h1>Activities</h1>
    <div class="subtitle">Track events, volunteer sessions, and other activities</div>
  </div>
  <div>
    <button class="add-btn" onclick="showAddActivityForm()">
      <i class="fas fa-plus"></i> New Activity
    </button>
  </div>
</div>

<div style="margin-top:18px;">
  <div class="search-row">
    <input type="search" id="activitySearch" placeholder="ðŸ” Search activities..." />
    <select id="typeFilter">
      <option value="">All Types</option>
      <option value="Event">Event</option>
      <option value="Workshop">Workshop</option>
      <option value="Volunteer Session">Volunteer Session</option>
      <option value="Fundraising">Fundraising</option>
      <option value="Community Outreach">Community Outreach</option>
    </select>
  </div>

  <div class="table">
    <table id="activitiesTable">
      <thead>
        <tr>
          <th>Activity Name</th>
          <th>Type</th>
          <th>Date</th>
          <th>Location</th>
          <th>Budget</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="6" style="text-align:center; color:var(--muted); padding:40px;">
            <i class="fas fa-spinner fa-spin" style="font-size:24px; margin-bottom:12px;"></i>
            <div>Loading activities...</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal for Add New Activity Form -->
<div id="addActivityModal" class="modal" style="display:none;">
  <div class="form-container">
    <header class="form-header">
      <h2><i class="fas fa-calendar-plus" style="margin-right:10px;"></i>Create New Activity</h2>
      <button class="close-btn" onclick="closeActivityForm()">Ã—</button>
    </header>

    <form id="activityForm" style="padding: 32px;">
      <div class="form-row full-width">
        <div class="form-group">
          <label for="activityName">Activity Name *</label>
          <input type="text" id="activityName" name="activityName" required placeholder="Enter activity name">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="activityType">Activity Type *</label>
          <select id="activityType" name="activityType" required>
            <option value="Event">Event</option>
            <option value="Workshop">Workshop</option>
            <option value="Volunteer Session">Volunteer Session</option>
            <option value="Fundraising">Fundraising</option>
            <option value="Community Outreach">Community Outreach</option>
          </select>
        </div>
        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="Planning">Planning</option>
            <option value="Active">Active</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">Start Date *</label>
          <input type="date" id="startDate" name="startDate" required>
        </div>
        <div class="form-group">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate" name="endDate">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="location">Location</label>
          <input type="text" id="location" name="location" placeholder="Activity location">
        </div>
        <div class="form-group">
          <label for="expectedAttendees">Expected Attendees</label>
          <input type="number" id="expectedAttendees" name="expectedAttendees" value="0" min="0" placeholder="0">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="budget">Budget ($)</label>
          <input type="number" id="budget" name="budget" value="0" min="0" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
          <label for="volunteersNeeded">Volunteers Needed</label>
          <input type="number" id="volunteersNeeded" name="volunteersNeeded" value="0" min="0" placeholder="0">
        </div>
      </div>

      <div class="form-row full-width">
        <div class="form-group">
          <label for="organizer">Organizer</label>
          <input type="text" id="organizer" name="organizer" placeholder="Organizer name">
        </div>
      </div>

      <div class="form-row full-width">
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="3" placeholder="Activity description"></textarea>
        </div>
      </div>

      <div class="form-row full-width">
        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Additional notes"></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn cancel-btn" onclick="closeActivityForm()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn create-btn">
          <i class="fas fa-check"></i> Create
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let allActivities = [];

  function showAddActivityForm() {
    document.getElementById('addActivityModal').style.display = 'flex';
    document.getElementById('addActivityModal').style.alignItems = 'center';
    document.getElementById('addActivityModal').style.justifyContent = 'center';
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
  }

  function closeActivityForm() {
    document.getElementById('addActivityModal').style.display = 'none';
    document.getElementById('activityForm').reset();
  }

  // Handle form submission
  document.getElementById('activityForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="loading"></span> Creating...';
    submitBtn.disabled = true;

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/api/add_activity', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      
      if (result.success) {
        if (typeof showNotification === 'function') {
          showNotification('Activity added successfully!', 'success');
        } else {
          alert('Activity added successfully!');
        }
        closeActivityForm();
        loadActivities();
        // Trigger dashboard refresh
        if (typeof triggerDashboardRefresh === 'function') {
          triggerDashboardRefresh();
        } else {
          localStorage.setItem('dashboardRefresh', Date.now().toString());
        }
      } else {
        if (typeof showNotification === 'function') {
          showNotification('Error: ' + result.message, 'error');
        } else {
          alert('Error adding activity: ' + result.message);
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      if (typeof showNotification === 'function') {
        showNotification('Error adding activity', 'error');
      } else {
        alert('Error adding activity');
      }
    });
  });

  // Load and filter activities
  function loadActivities() {
    const tbody = document.querySelector('#activitiesTable tbody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--muted); padding:40px;"><i class="fas fa-spinner fa-spin" style="font-size:24px; margin-bottom:12px;"></i><div>Loading activities...</div></td></tr>';
    
    fetch('/api/activities')
      .then(r => r.json())
      .then(data => {
        allActivities = data;
        filterAndRenderActivities();
      })
      .catch(err => {
        console.error('Error loading activities:', err);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger); padding:40px;">Error loading activities</td></tr>';
      });
  }

  function filterAndRenderActivities() {
    const searchQuery = document.getElementById('activitySearch').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    
    let filtered = allActivities.filter(item => {
      const matchesSearch = !searchQuery || 
        item.name?.toLowerCase().includes(searchQuery) ||
        item.description?.toLowerCase().includes(searchQuery);
      const matchesType = !typeFilter || item.activity_type === typeFilter;
      
      return matchesSearch && matchesType;
    });

    const tbody = document.querySelector('#activitiesTable tbody');
    if (!filtered.length) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--muted); padding:40px;"><i class="fas fa-calendar-alt" style="font-size:32px; margin-bottom:12px; opacity:0.3;"></i><div>No activities found</div></td></tr>';
      return;
    }

    const typeColors = {
      'Event': '#3b82f6',
      'Workshop': '#10b981',
      'Volunteer Session': '#f59e0b',
      'Fundraising': '#8b5cf6',
      'Community Outreach': '#ef4444'
    };

    tbody.innerHTML = filtered.map(item => {
      const typeColor = typeColors[item.activity_type] || '#64748b';
      const startDate = item.start_date ? new Date(item.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
      const budget = item.budget ? parseFloat(item.budget) : 0;
      
      return `
        <tr>
          <td style="font-weight:600; color:#0f172a;">${item.name || 'Unnamed Activity'}</td>
          <td>
            <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:12px; background:${typeColor}15; color:${typeColor}; font-weight:600; font-size:12px;">
              ${item.activity_type || 'N/A'}
            </span>
          </td>
          <td style="color:var(--muted); font-size:13px;">${startDate}</td>
          <td style="color:var(--muted); font-size:13px;">${item.location || 'N/A'}</td>
          <td style="font-weight:600; color:#10b981;">$${budget.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
          <td><span class="status-badge ${item.status === 'Completed' ? 'active' : item.status === 'Cancelled' ? 'inactive' : 'pending'}">${item.status || 'Planning'}</span></td>
        </tr>
      `;
    }).join('');
  }

  // Event listeners for filtering
  document.getElementById('activitySearch').addEventListener('input', filterAndRenderActivities);
  document.getElementById('typeFilter').addEventListener('change', filterAndRenderActivities);

  // Load activities when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadActivities();
  });
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="page-title">
  <div>
    <h1>Dashboard</h1>
    <div class="subtitle">Welcome back! Here's what's happening with your organization.</div>
  </div>
  <div>
    <button class="add-btn" onclick="location.href='/activities'">
      <i class="fas fa-plus"></i> New Activity
    </button>
  </div>
</div>

<div class="cards">
  <div class="card">
    <h3><i class="fas fa-users" style="color: #3b82f6;"></i> Active Volunteers</h3>
    <p id="activeVolunteers">0</p>
    <small>Managing your community</small>
  </div>

  <div class="card">
    <h3><i class="fas fa-project-diagram" style="color: #10b981;"></i> Active Projects</h3>
    <p id="activeProjects">0</p>
    <small>Ongoing initiatives</small>
  </div>

  <div class="card">
    <h3><i class="fas fa-donate" style="color: #8b5cf6;"></i> Total Donations</h3>
    <p id="totalDonations">$0.00</p>
    <small>Financial contributions</small>
  </div>

  <div class="card">
    <h3><i class="fas fa-clock" style="color: #f59e0b;"></i> Volunteer Hours</h3>
    <p id="volHours">0</p>
    <small>Total hours contributed</small>
  </div>
</div>

<div class="grid-2">
      </div>
    </div>
  </div>

  <div class="dashboard-grid">

  <!-- Active Projects -->
  <div class="card dashboard-card">
    <h3 class="card-title">
      <i class="fas fa-tasks" style="color:#ef4444;"></i>
      Active Projects
    </h3>

    <div id="activeProjectsList" class="card-content">
      <div class="empty-state">
        <i class="fas fa-folder-open empty-icon"></i>
        <p>No active projects</p>
      </div>
    </div>
  </div>

  <!-- Recent Activities -->
  <div class="card dashboard-card">
    <h3 class="card-title">
      <i class="fas fa-calendar-check" style="color:#06b6d4;"></i>
      Recent Activities
    </h3>

    <div id="recentActivities" class="card-content">
      <div class="empty-state">
        <i class="fas fa-calendar-alt empty-icon"></i>
        <p>No recent activities</p>
      </div>
    </div>
  </div>

</div>


<div class="card">
  <h3><i class="fas fa-history" style="color: #64748b;"></i> Recent Form Submissions</h3>
  <div style="padding:8px 0; margin-bottom:12px; display:flex; justify-content:space-between; align-items: center;">
    <small style="color:var(--muted);">Latest entries from all forms</small>
    <button id="refreshBtn" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:14px; display:flex; align-items:center; gap:6px; padding:4px 8px; border-radius:6px; transition:var(--transition);" onmouseover="this.style.background='rgba(59, 130, 246, 0.1)'" onmouseout="this.style.background='none'">
      <i class="fas fa-sync-alt"></i> Refresh
    </button>
  </div>
  <div id="recentEntries" style="min-height:200px; max-height:400px; overflow-y:auto; padding:8px 0;">
    <div class="empty-box" style="min-height:200px;">
      <i class="fas fa-spinner fa-spin" style="font-size:24px; margin-bottom:12px;"></i>
      <p>Loading recent entries...</p>
    </div>
  </div>
</div>

<div class="cards" style="margin-top:32px;">
  <div class="card" style="cursor:pointer; text-align:center;" onclick="location.href='/stakeholders'">
    <i class="fas fa-users" style="font-size:32px; color:#3b82f6; margin-bottom:12px;"></i>
    <h3>Stakeholders</h3>
    <p style="font-size:16px; color:var(--muted); margin-top:8px;">Manage volunteers, donors and beneficiaries</p>
  </div>
  <div class="card" style="cursor:pointer; text-align:center;" onclick="location.href='/projects'">
    <i class="fas fa-folder-open" style="font-size:32px; color:#10b981; margin-bottom:12px;"></i>
    <h3>Projects</h3>
    <p style="font-size:16px; color:var(--muted); margin-top:8px;">Track programs and initiatives</p>
  </div>
  <div class="card" style="cursor:pointer; text-align:center;" onclick="location.href='/donations'">
    <i class="fas fa-donate" style="font-size:32px; color:#8b5cf6; margin-bottom:12px;"></i>
    <h3>Donations</h3>
    <p style="font-size:16px; color:var(--muted); margin-top:8px;">Receive and record donations</p>
  </div>
</div>

<script>
  // Load recent activities and setup event listeners
  document.addEventListener('DOMContentLoaded', function() {
    loadRecentActivities();
    loadActiveProjectsList();
    loadRecentEntries();
    
    // Setup refresh button
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        const icon = this.querySelector('i');
        if (icon) {
          icon.classList.add('fa-spin');
        }
        loadRecentEntries();
        loadRecentActivities();
        loadActiveProjectsList();
        loadSummary();
        setTimeout(() => {
          if (icon) {
            icon.classList.remove('fa-spin');
          }
        }, 1000);
      });
    }
    
    // Listen for storage events to refresh when forms are submitted from other pages/tabs
    window.addEventListener('storage', function(e) {
      if (e.key === 'dashboardRefresh') {
        loadRecentEntries();
        loadRecentActivities();
        loadActiveProjectsList();
        loadSummary();
      }
    });
    
    // Also listen for custom events (for same-tab updates)
    window.addEventListener('dashboardRefresh', function() {
      loadRecentEntries();
      loadRecentActivities();
      loadActiveProjectsList();
      loadSummary();
    });
    
    // Check localStorage periodically for same-tab updates
    let lastRefresh = localStorage.getItem('dashboardRefresh') || '0';
    setInterval(function() {
      const currentRefresh = localStorage.getItem('dashboardRefresh') || '0';
      if (currentRefresh !== lastRefresh) {
        lastRefresh = currentRefresh;
        loadRecentEntries();
        loadRecentActivities();
        loadActiveProjectsList();
        loadSummary();
      }
    }, 1000); // Check every second
  });
  
  function loadRecentEntries() {
    fetch('/api/recent_entries')
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('recentEntries');
        if (!data || !data.length) {
          container.innerHTML = '<div style="text-align:center; color:var(--muted); padding:40px;"><i class="fas fa-inbox" style="font-size:32px; opacity:0.3; margin-bottom:12px;"></i><div>No recent entries</div></div>';
          return;
        }
        
        container.innerHTML = data.map((entry, index) => {
          const date = new Date(entry.date);
          const typeColors = {
            'Volunteer': '#3b82f6',
            'Donor': '#10b981',
            'Beneficiary': '#f59e0b',
            'Event': '#8b5cf6',
            'Donation': '#ef4444'
          };
          const typeIcons = {
            'Volunteer': 'fa-user',
            'Donor': 'fa-hand-holding-usd',
            'Beneficiary': 'fa-heart',
            'Event': 'fa-calendar',
            'Donation': 'fa-donate'
          };
          const color = typeColors[entry.type] || '#64748b';
          const icon = typeIcons[entry.type] || 'fa-circle';
          
          return `
            <div style="padding:12px 16px; border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between; align-items:center; transition:var(--transition-fast); border-radius:var(--radius); margin-bottom:8px; background:white;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
              <div style="display:flex; align-items:center; gap:12px; flex:1;">
                <div style="width:40px; height:40px; border-radius:50%; background:${color}15; display:flex; align-items:center; justify-content:center;">
                  <i class="fas ${icon}" style="color:${color}; font-size:18px;"></i>
                </div>
                <div style="flex:1;">
                  <div style="font-weight:600; color:#0f172a; font-size:14px; margin-bottom:4px;">
                    <span style="display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:12px; background:${color}15; color:${color}; font-size:11px; font-weight:700; text-transform:uppercase; margin-right:8px;">${entry.type}</span>
                    ${entry.name || 'Unnamed Entry'}
                  </div>
                  <div style="color:var(--muted); font-size:12px;">
                    <i class="fas fa-clock" style="margin-right:4px;"></i>
                    ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      })
      .catch(err => {
        console.error('Error loading recent entries:', err);
        document.getElementById('recentEntries').innerHTML = 
          '<div style="text-align:center; color:var(--danger); padding:40px;">Error loading entries</div>';
      });
  }

  function loadRecentActivities() {
    fetch('/api/activities')
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('recentActivities');
        if (!data || !data.length) {
          container.innerHTML = '<div style="text-align:center;"><i class="fas fa-calendar-alt" style="font-size:48px; opacity:0.3; margin-bottom:16px;"></i><p>No recent activities</p></div>';
          return;
        }
        const recent = data.slice(0, 5);
        container.innerHTML = recent.map((item, index) => `
          <div style="padding:12px 0; border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:600; color:#0f172a;">${item.name || 'Unnamed Activity'}</div>
              <div style="color:var(--muted); font-size:13px; margin-top:4px;">
                <i class="fas fa-map-marker-alt" style="margin-right:6px;"></i>${item.location || 'N/A'}
              </div>
            </div>
            <div style="color:var(--muted); font-size:13px; font-weight:500;">
              ${item.start_date ? new Date(item.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A'}
            </div>
          </div>
        `).join('');
      })
      .catch(err => {
        console.error('Error loading activities:', err);
      });
  }

  function loadActiveProjectsList() {
    fetch('/api/projects')
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('activeProjectsList');
        if (!data || !data.length) {
          container.innerHTML = '<div style="text-align:center;"><i class="fas fa-folder-open" style="font-size:48px; opacity:0.3; margin-bottom:16px;"></i><p>No active projects</p></div>';
          return;
        }
        const active = data.slice(0, 5);
        container.innerHTML = active.map(item => `
          <div style="padding:12px 0; border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:600; color:#0f172a;">${item.name || 'Unnamed Project'}</div>
              <div style="color:var(--muted); font-size:13px; margin-top:4px;">
                <i class="fas fa-calendar" style="margin-right:6px;"></i>${item.start_date ? new Date(item.start_date).toLocaleDateString() : 'N/A'}
              </div>
            </div>
            <div style="color:var(--muted); font-size:13px;">
              ${item.budget ? '$' + parseFloat(item.budget).toLocaleString() : 'N/A'}
            </div>
          </div>
        `).join('');
      })
      .catch(err => {
        console.error('Error loading projects:', err);
      });
  }
</script>
{% endblock %}
